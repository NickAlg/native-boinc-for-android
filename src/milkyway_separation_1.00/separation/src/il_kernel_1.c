/*
 *  Copyright (c) 2010-2011 Matthew Arsenault
 *  Copyright (c) 2010-2011 Rensselaer Polytechnic Institute
 *
 *  This file is part of Milkway@Home.
 *
 *  Milkway@Home is free software: you may copy, redistribute and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation, either version 3 of the License, or (at your
 *  option) any later version.
 *
 *  This file is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "il_kernels.h"

const char* ilKernelSrc1 =
"il_cs_2_0\n"
"dcl_num_thread_per_group 64\n"
"; 1 stream kernel\n"
"dcl_cb cb0[15]  ; Constant buffer that holds ABI data\n"
"dcl_cb cb1[15]  ; Kernel arguments\n"
"dcl_cb cb2[72]  ; I'm guessing the math constants AMD uses\n"
"dcl_cb cb3[8]   ; ap constants\n"
"dcl_cb cb4[4]   ; stream constants\n"
"dcl_cb cb5[128] ; sg_dx\n"
"dcl_raw_uav_id(%d)\n"
"dcl_literal l0, 0x0, 0x0, 0x0, 0x0\n"
"dcl_literal l9, 0x0, 0x3fe00000, 0x0, 0x0\n"
"dcl_literal l5, 0x0, 0x3fe80000, 0x0, 0x0\n"
"dcl_literal l7, 0x0, 0x3ff00000, 0x0, 0x0\n"
"dcl_literal l6, 0x0, 0xbfb00000, 0x0, 0x0\n"
"dcl_literal l16, 0x0, 0xbfe00000, 0x0, 0x0\n"
"dcl_literal l4, 0x0, 0xc0080000, 0x0, 0x0\n"
"dcl_literal l3, 0x8, 0x0, 0x0, 0x0\n"
"dcl_literal l2, 0x10, 0x0, 0x0, 0x0\n"
"dcl_literal l15, 0x389cefdd, 0x3fabf3e7, 0x0, 0x0\n"
"dcl_literal l13, 0x47900215, 0x3f33185f, 0x0, 0x0\n"
"dcl_literal l11, 0x4d1d3b2f, 0x3ef52b5c, 0x0, 0x0\n"
"dcl_literal l8, 0x652b82fe, 0x3ff71547, 0x0, 0x0\n"
"dcl_literal l17, 0x667f3bcd, 0x3ff6a09e, 0x0, 0x0\n"
"dcl_literal l10, 0xb649a8f5, 0x3f84aa4e, 0x0, 0x0\n"
"dcl_literal l14, 0xd100e689, 0x3e8657cd, 0x0, 0x0\n"
"dcl_literal l12, 0xfefa39ec, 0x3fe62e42, 0x0, 0x0\n"
"dcl_literal l1, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff\n"
"dcl_arena_uav_id(8)\n"
"mov r17.x,cb3[1].x\n"
"mov r18.x,cb3[1].y\n"
"iadd r21.x,vAbsTid.x,cb0[6].x\n"
"mov r22.x,r21.x\n"
"inegate r23.x,cb1[9].x\n"
"iadd r24.x,r22.x,r23.x\n"
"mov r27.x,r24.x\n"
"umod r28.x,r27.x,cb1[11].x\n"
"mov r31.x,r28.x\n"
"udiv r32.x,r27.x,cb1[11].x\n"
"mov r35.x,r32.x\n"
"mov r36.x,l2.x\n"
"mov r38.x,l3.x\n"
"ult r43.x,r35.x,cb1[10].x\n"
"ult r40.x,r31.x,cb1[11].x\n"
"iand r46.x,r43.x,r40.x\n"
"mov r49.x,r46.x\n"
"if_logicalnz r49.x\n"
"mov r50.xy,l0.xy\n"
";Zero streams\n"
"mov r52.xy,l0.xy\n"
"mov r54.xy,r52.xy\n"
"umul r55.x,r36.x,r17.x\n"
"umul r60.x,r55.x,r35.x\n"
"mov r65.x,r60.x\n"
"iadd r66.x,r65.x,cb1[3].x\n"
"mov r69.x,r66.x\n"
"umul r70.x,r36.x,r17.x\n"
"iadd r75.x,r69.x,r70.x\n"
"mov r80.x,r75.x\n"
"umul r81.x,cb1[14].x,cb1[11].x\n"
"iadd r82.x,r81.x,r31.x\n"
"mov r85.x,r82.x\n"
"umul r86.x,r36.x,r85.x\n"
"iadd r91.x,r86.x,cb1[4].x\n"
"mov r94.x,r91.x\n"
"umul r95.x,r38.x,r85.x\n"
"iadd r100.x,r95.x,cb1[5].x\n"
"mov r103.x,r100.x\n"
"umul r104.x,r31.x,cb1[10].x\n"
"iadd r107.x,r104.x,r35.x\n"
"mov r111.x,r107.x\n"
";Read Trig\n"
"uav_raw_load_id(%d) r112.xyzw,r94.x\n"
"mov r113.xyzw,r112.xyzw\n"
"mov r116,r113\n"
"uav_raw_load_id(%d) r117.xy__,r103.x\n"
"mov r118.xy__,r117.xy00\n"
"mov r121.xy,r118.xy\n"
";read old values\n"
"mov r122.x,l2.x\n"
"umul r124.x,r122.x,r111.x\n"
"iadd r129.x,r124.x,cb1[0].x\n"
"uav_raw_load_id(%d) r132.xyzw,r129.x\n"
"mov r133.xyzw,r132.xyzw\n"
"mov r136,r133\n"
"umul r137.x,cb1[10].x,cb1[11].x\n"
"mov r138.x,r137.x\n"
"mov r139,l0\n"
"mov r141.x,l0.x\n"
"mov r153.x,l2.x\n"
"umul r143.x,r141.x,r138.x\n"
"iadd r148.x,r111.x,r143.x\n"
"umul r155.x,r153.x,r148.x\n"
"iadd r161.x,r155.x,cb1[1].x\n"
"uav_raw_load_id(%d) r166.xyzw,r161.x\n"
"mov r167.xyzw,r166.xyzw\n"
"mov r139,r167\n"
"mov r172,r139\n"
"whileloop\n"
"uav_raw_load_id(%d) r173.xyzw,r69.x\n"
"mov r174.xyzw,r173.xyzw\n"
"mov r177,r174\n"
";coordinate conversion\n"
"dmad r184.xy,r177.xy,r116.xy,cb3[2].xy\n"
"mov r187.xy,r184.xy\n"
"dmul r194.xy,r177.xy,r116.zw\n"
"mov r197.xy,r194.xy\n"
"dmul r201.xy,r177.xy,r121.xy\n"
"mov r205.xy,r201.xy\n"
";x^2 + y^2 + z^2 / q^2\n"
"dmul r206.xy,r187.xy,r187.xy\n"
"mov r211.xy,r206.xy\n"
"dmad r212.xy,r197.xy,r197.xy,r211.xy\n"
"mov r219.xy,r212.xy\n"
"dmul r220.xy,r205.xy,r205.xy\n"
"mov r225.xy,r220.xy\n"
"dmad r226.xy,cb3[3].xy,r225.xy,r219.xy\n"
"mov r231.xy,r226.xy\n"
";sqrt()\n"
"mov r232.xy,r231.xy\n"
"mov r235,r232.xy\n"
"call 1\n"
"mov r233.xy,r234\n"
"mov r232.xy,r235\n"
"dadd r286.xy,r233.xy,cb3[2].zw\n"
"mov r289.xy,r286.xy\n"
";qw_r3_N / (rg *rs^3)\n"
"dmul r290.xy,r233.xy,r289.xy\n"
"dmul r295.xy,r290.xy,r289.xy\n"
"dmul r300.xy,r295.xy,r289.xy\n"
"mov r306.xy,r300.xy\n"
"mov r310.xy,r177.zw\n"
"mov r313,r310.xy\n"
"mov r314,r306.xy\n"
"call 2\n"
"mov r311.xy,r312\n"
"mov r310.xy,r313\n"
"mov r306.xy,r314\n"
"dadd r368.xy,r50.xy,r311.xy\n"
"mov r50.xy,r368.xy\n"
";stream loops\n"
";Begin stream\n"
";x - c\n"
"dadd r378.xy,r187.xy,cb4[0].zw_neg(y)\n"
"mov r381.xy,r378.xy\n"
"dadd r383.xy,r197.xy,cb4[1].zw_neg(y)\n"
"mov r386.xy,r383.xy\n"
"dadd r388.xy,r205.xy,cb4[2].zw_neg(y)\n"
"mov r391.xy,r388.xy\n"
";a . x\n"
"dmul r393.xy,cb4[0].xy,r381.xy\n"
"mov r396.xy,r393.xy\n"
"dmad r398.xy,cb4[1].xy,r386.xy,r396.xy\n"
"mov r396.xy,r398.xy\n"
"dmad r404.xy,cb4[2].xy,r391.xy,r396.xy\n"
"mov r396.xy,r404.xy\n"
";xs += dotted * (-a)\n"
"mov r410.xy,cb4[0].xy_neg(y)\n"
"dmad r411.xy,r396.xy,r410.xy,r381.xy\n"
"mov r381.xy,r411.xy\n"
"mov r417.xy,cb4[1].xy_neg(y)\n"
"dmad r418.xy,r396.xy,r417.xy,r386.xy\n"
"mov r386.xy,r418.xy\n"
"mov r424.xy,cb4[2].xy_neg(y)\n"
"dmad r425.xy,r396.xy,r424.xy,r391.xy\n"
"mov r391.xy,r425.xy\n"
";sqrv\n"
"dmul r430.xy,r381.xy,r381.xy\n"
"mov r435.xy,r430.xy\n"
"dmad r436.xy,r386.xy,r386.xy,r435.xy\n"
"mov r435.xy,r436.xy\n"
"dmad r443.xy,r391.xy,r391.xy,r435.xy\n"
"mov r435.xy,r443.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r450.xy,cb4[3].xy_neg(y)\n"
"dmul r451.xy,r435.xy,r450.xy\n"
"mov r435.xy,r451.xy\n"
";increment stream integral\n"
"mov r454.xy,r435.xy\n"
"mov r457,r454.xy\n"
"call 3\n"
"mov r455.xy,r456\n"
"mov r454.xy,r457\n"
"dmad r600.xy,r177.zw,r455.xy,r54.xy\n"
"mov r54.xy,r600.xy\n"
";End streams\n"
"iadd r606.x,r69.x,r36.x\n"
"mov r69.x,r606.x\n"
"uge r611.x,r69.x,r80.x\n"
"break_logicalnz r611.x\n"
"endloop\n"
"umul r616.x,r36.x,r35.x\n"
"iadd r621.x,r616.x,cb1[2].x\n"
"uav_raw_load_id(%d) r624.xyzw,r621.x\n"
"mov r625.xyzw,r624.xyzw\n"
"dmul r631.xy,cb1[13].xy,r625.xy\n"
"mov r634.xy,r631.xy\n"
";multiply V_reff_xr_rp3 with Kahan summation\n"
"dmul r635.xy,r50.xy,r634.xy\n"
"mov r50.xy,r635.xy\n"
"mov r640.xy,r50.xy\n"
"mov r641,r136\n"
"dadd r645.xy,r640.xy,r641.zw\n"
"mov r649.xy,r645.xy\n"
"dadd r653.xy,r641.xy,r649.xy\n"
"mov r657.xy,r653.xy\n"
"dadd r661.xy,r657.xy,r641.xy_neg(y)\n"
"dadd r665.xy,r649.xy,r661.xy_neg(y)\n"
"mov r641.__zw,r665.00xy\n"
"mov r641.xy__,r657.xy00\n"
"mov r676,r641\n"
"mov r136,r676\n"
"mov r677,r136\n"
"dmul r678.xy,r54.xy,r634.xy\n"
"mov r54.xy,r678.xy\n"
"mov r683.xy,r54.xy\n"
"mov r684,r172\n"
"dadd r688.xy,r683.xy,r684.zw\n"
"mov r692.xy,r688.xy\n"
"dadd r696.xy,r684.xy,r692.xy\n"
"mov r700.xy,r696.xy\n"
"dadd r704.xy,r700.xy,r684.xy_neg(y)\n"
"dadd r708.xy,r692.xy,r704.xy_neg(y)\n"
"mov r684.__zw,r708.00xy\n"
"mov r684.xy__,r700.xy00\n"
"mov r719,r684\n"
"mov r172,r719\n"
"mov r720,r172\n"
";Output\n"
"mov r721.x,l2.x\n"
"umul r723.x,r721.x,r111.x\n"
"iadd r728.x,r723.x,cb1[0].x\n"
"uav_raw_store_id(%d) mem.xyzw,r728.x,r136\n"
"mov r735.x,l0.x\n"
"mov r747.x,l2.x\n"
"umul r737.x,r735.x,r138.x\n"
"iadd r742.x,r111.x,r737.x\n"
"umul r749.x,r747.x,r742.x\n"
"iadd r755.x,r749.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r755.x,r172\n"
"endif\n"
"endmain\n"
"func 2\n"
";div_custom\n"
"d2f r315.x,r314.xy\n"
"mov r318.x,r315.x\n"
"mov r319.x,r318.x\n"
"rcp r320.x___,r319.xxxx\n"
"mov r323.x,r320.x\n"
"f2d r324.xy,r323.x\n"
"mov r327.xy,r324.xy\n"
"mov r328.xy,r314.xy_neg(y)\n"
"dmad r332.xy,r328.xy,r327.xy,l7.xy\n"
"mov r336.xy,r332.xy\n"
"dmad r337.xy,r327.xy,r336.xy,r327.xy\n"
"mov r344.xy,r337.xy\n"
"dmul r345.xy,r313.xy,r344.xy\n"
"mov r350.xy,r345.xy\n"
"mov r351.xy,r314.xy_neg(y)\n"
"dmad r354.xy,r351.xy,r350.xy,r313.xy\n"
"mov r360.xy,r354.xy\n"
"dmad r361.xy,r360.xy,r344.xy,r350.xy\n"
"mov r312.xy,r361.xy\n"
"ret\n"
"endfunc\n"
"func 1\n"
";sqrt_custom\n"
"d2f r236.x,r235.xy\n"
"mov r239.x,r236.x\n"
"rsq r240.x___,r239.xxxx\n"
"mov r243.x,r240.x\n"
"mov r244.x,r243.x_neg(x)\n"
"f2d r247.xy,r244.x\n"
"mov r249.xy,r247.xy\n"
"dmul r250.xy,r249.xy,r249.xy\n"
"mov r255.xy,r250.xy\n"
"dmad r257.xy,r235.xy,r255.xy,l4.xy\n"
"mov r255.xy,r257.xy\n"
"dmul r262.xy,r249.xy,r255.xy\n"
"mov r249.xy,r262.xy\n"
"dmul r267.xy,r235.xy,r249.xy\n"
"mov r255.xy,r267.xy\n"
"dmul r272.xy,r249.xy,r255.xy\n"
"mov r249.xy,r272.xy\n"
"dmad r279.xy,r249.xy,l6.xy,l5.xy\n"
"dmul r282.xy,r255.xy,r279.xy\n"
"mov r234.xy,r282.xy\n"
"ret\n"
"endfunc\n"
"func 3\n"
";exp_custom\n"
"dmul r459.xy,r457.xy,l8.xy\n"
"mov r462.xy,r459.xy\n"
"dfrac r463.xy,r462.xy\n"
"mov r466.xy,r463.xy\n"
"dadd r467.xy,r462.xy,r466.xy_neg(y)\n"
"d2f r472.x, r467.xy\n"
"ftoi r473.x,r472.x\n"
"mov r476.x,r473.x\n"
"dadd r478.xy,r466.xy,l9.xy_neg(y)\n"
"mov r481.xy,r478.xy\n"
"dmul r482.xy,r481.xy,r481.xy\n"
"mov r487.xy,r482.xy\n"
"dmad r490.xy,r487.xy,l11.xy,l10.xy\n"
"mov r493.xy,r490.xy\n"
"dmad r495.xy,r487.xy,r493.xy,l12.xy\n"
"dmul r500.xy,r481.xy,r495.xy\n"
"mov r505.xy,r500.xy\n"
"dmad r508.xy,r487.xy,l14.xy,l13.xy\n"
"mov r511.xy,r508.xy\n"
"dmad r513.xy,r487.xy,r511.xy,l15.xy\n"
"mov r511.xy,r513.xy\n"
"dmad r519.xy,r487.xy,r511.xy,l7.xy\n"
"mov r511.xy,r519.xy\n"
"dmad r525.xy,r505.xy,l16.xy,r511.xy\n"
"mov r530.xy,r525.xy\n"
"mov r531.xy,r530.xy\n"
"mov r532.xy,r505.xy\n"
"mov r313,r532.xy\n"
"mov r314,r531.xy\n"
"call 2\n"
"mov r533.xy,r312\n"
"mov r532.xy,r313\n"
"mov r531.xy,r314\n"
"dmad r589.xy,r533.xy,l17.xy,l17.xy\n"
"mov r533.xy,r589.xy\n"
"dldexp r592.xy,r533.xy,r476.x\n"
"mov r456.xy,r592.xy\n"
"ret\n"
"endfunc\n"
"end\n";

