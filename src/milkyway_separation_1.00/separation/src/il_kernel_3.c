/*
 *  Copyright (c) 2010-2011 Matthew Arsenault
 *  Copyright (c) 2010-2011 Rensselaer Polytechnic Institute
 *
 *  This file is part of Milkway@Home.
 *
 *  Milkway@Home is free software: you may copy, redistribute and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation, either version 3 of the License, or (at your
 *  option) any later version.
 *
 *  This file is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "il_kernels.h"

const char* ilKernelSrc3 =
"il_cs_2_0\n"
"dcl_num_thread_per_group 64\n"
"; 3 stream kernel\n"
"dcl_cb cb0[15]  ; Constant buffer that holds ABI data\n"
"dcl_cb cb1[15]  ; Kernel arguments\n"
"dcl_cb cb2[72]  ; I'm guessing the math constants AMD uses\n"
"dcl_cb cb3[8]   ; ap constants\n"
"dcl_cb cb4[12]  ; stream constants\n"
"dcl_cb cb5[128] ; sg_dx\n"
"dcl_raw_uav_id(%d)\n"
"dcl_literal l0, 0x0, 0x0, 0x0, 0x0\n"
"dcl_literal l11, 0x0, 0x3fe00000, 0x0, 0x0\n"
"dcl_literal l7, 0x0, 0x3fe80000, 0x0, 0x0\n"
"dcl_literal l9, 0x0, 0x3ff00000, 0x0, 0x0\n"
"dcl_literal l8, 0x0, 0xbfb00000, 0x0, 0x0\n"
"dcl_literal l18, 0x0, 0xbfe00000, 0x0, 0x0\n"
"dcl_literal l6, 0x0, 0xc0080000, 0x0, 0x0\n"
"dcl_literal l4, 0x1, 0x0, 0x0, 0x0\n"
"dcl_literal l5, 0x2, 0x0, 0x0, 0x0\n"
"dcl_literal l3, 0x8, 0x0, 0x0, 0x0\n"
"dcl_literal l2, 0x10, 0x0, 0x0, 0x0\n"
"dcl_literal l17, 0x389cefdd, 0x3fabf3e7, 0x0, 0x0\n"
"dcl_literal l15, 0x47900215, 0x3f33185f, 0x0, 0x0\n"
"dcl_literal l13, 0x4d1d3b2f, 0x3ef52b5c, 0x0, 0x0\n"
"dcl_literal l10, 0x652b82fe, 0x3ff71547, 0x0, 0x0\n"
"dcl_literal l19, 0x667f3bcd, 0x3ff6a09e, 0x0, 0x0\n"
"dcl_literal l12, 0xb649a8f5, 0x3f84aa4e, 0x0, 0x0\n"
"dcl_literal l16, 0xd100e689, 0x3e8657cd, 0x0, 0x0\n"
"dcl_literal l14, 0xfefa39ec, 0x3fe62e42, 0x0, 0x0\n"
"dcl_literal l1, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff\n"
"dcl_arena_uav_id(8)\n"
"mov r17.x,cb3[1].x\n"
"mov r18.x,cb3[1].y\n"
"iadd r21.x,vAbsTid.x,cb0[6].x\n"
"mov r22.x,r21.x\n"
"inegate r23.x,cb1[9].x\n"
"iadd r24.x,r22.x,r23.x\n"
"mov r27.x,r24.x\n"
"umod r28.x,r27.x,cb1[11].x\n"
"mov r31.x,r28.x\n"
"udiv r32.x,r27.x,cb1[11].x\n"
"mov r35.x,r32.x\n"
"mov r36.x,l2.x\n"
"mov r38.x,l3.x\n"
"ult r43.x,r35.x,cb1[10].x\n"
"ult r40.x,r31.x,cb1[11].x\n"
"iand r46.x,r43.x,r40.x\n"
"mov r49.x,r46.x\n"
"if_logicalnz r49.x\n"
"mov r50.xy,l0.xy\n"
";Zero streams\n"
"mov r52.xy,l0.xy\n"
"mov r54.xy,r52.xy\n"
"mov r55.xy,l0.xy\n"
"mov r57.xy,r55.xy\n"
"mov r58.xy,r54.xy\n"
"mov r59.xy,l0.xy\n"
"mov r61.xy,r59.xy\n"
"mov r62.xy,r58.xy\n"
"mov r63.xy,r57.xy\n"
"umul r64.x,r36.x,r17.x\n"
"umul r69.x,r64.x,r35.x\n"
"mov r74.x,r69.x\n"
"iadd r75.x,r74.x,cb1[3].x\n"
"mov r78.x,r75.x\n"
"umul r79.x,r36.x,r17.x\n"
"iadd r84.x,r78.x,r79.x\n"
"mov r89.x,r84.x\n"
"umul r90.x,cb1[14].x,cb1[11].x\n"
"iadd r91.x,r90.x,r31.x\n"
"mov r94.x,r91.x\n"
"umul r95.x,r36.x,r94.x\n"
"iadd r100.x,r95.x,cb1[4].x\n"
"mov r103.x,r100.x\n"
"umul r104.x,r38.x,r94.x\n"
"iadd r109.x,r104.x,cb1[5].x\n"
"mov r112.x,r109.x\n"
"umul r113.x,r31.x,cb1[10].x\n"
"iadd r116.x,r113.x,r35.x\n"
"mov r120.x,r116.x\n"
";Read Trig\n"
"uav_raw_load_id(%d) r121.xyzw,r103.x\n"
"mov r122.xyzw,r121.xyzw\n"
"mov r125,r122\n"
"uav_raw_load_id(%d) r126.xy__,r112.x\n"
"mov r127.xy__,r126.xy00\n"
"mov r130.xy,r127.xy\n"
";read old values\n"
"mov r131.x,l2.x\n"
"umul r133.x,r131.x,r120.x\n"
"iadd r138.x,r133.x,cb1[0].x\n"
"uav_raw_load_id(%d) r141.xyzw,r138.x\n"
"mov r142.xyzw,r141.xyzw\n"
"mov r145,r142\n"
"umul r146.x,cb1[10].x,cb1[11].x\n"
"mov r147.x,r146.x\n"
"mov r148,l0\n"
"mov r150.x,l0.x\n"
"mov r162.x,l2.x\n"
"umul r152.x,r150.x,r147.x\n"
"iadd r157.x,r120.x,r152.x\n"
"umul r164.x,r162.x,r157.x\n"
"iadd r170.x,r164.x,cb1[1].x\n"
"uav_raw_load_id(%d) r175.xyzw,r170.x\n"
"mov r176.xyzw,r175.xyzw\n"
"mov r148,r176\n"
"mov r181,r148\n"
"mov r182,l0\n"
"mov r184.x,l4.x\n"
"mov r196.x,l2.x\n"
"umul r186.x,r184.x,r147.x\n"
"iadd r191.x,r120.x,r186.x\n"
"umul r198.x,r196.x,r191.x\n"
"iadd r204.x,r198.x,cb1[1].x\n"
"uav_raw_load_id(%d) r209.xyzw,r204.x\n"
"mov r210.xyzw,r209.xyzw\n"
"mov r182,r210\n"
"mov r215,r182\n"
"mov r216,r181\n"
"mov r217,l0\n"
"mov r219.x,l5.x\n"
"mov r231.x,l2.x\n"
"umul r221.x,r219.x,r147.x\n"
"iadd r226.x,r120.x,r221.x\n"
"umul r233.x,r231.x,r226.x\n"
"iadd r239.x,r233.x,cb1[1].x\n"
"uav_raw_load_id(%d) r244.xyzw,r239.x\n"
"whileloop\n"
"uav_raw_load_id(%d) r253.xyzw,r78.x\n"
";coordinate conversion\n"
"dmad r264.xy,r253.xy,r125.xy,cb3[2].xy\n"
"dmul r274.xy,r253.xy,r125.zw\n"
"dmul r281.xy,r253.xy,r130.xy\n"
";x^2 + y^2 + z^2 / q^2\n"
"dmul r286.xy,r264.xy,r264.xy\n"
"dmad r292.xy,r274.xy,r274.xy,r286.xy\n"
"dmul r300.xy,r281.xy,r281.xy\n"
"dmad r315.xy,cb3[3].xy,r300.xy,r292.xy\n"
";sqrt()\n"
"call 1\n"
"dadd r366.xy,r314.xy,cb3[2].zw\n"
";qw_r3_N / (rg *rs^3)\n"
"dmul r370.xy,r314.xy,r366.xy\n"
"dmul r375.xy,r370.xy,r366.xy\n"
"dmul r380.xy,r375.xy,r366.xy\n"
"mov r393,r253.zw\n"
"mov r394,r380.xy\n"
"call 2\n"
"mov r390.xy,r393\n"
"mov r386.xy,r394\n"
"dadd r448.xy,r50.xy,r392.xy\n"
"mov r50.xy,r448.xy\n"
";stream loops\n"
";Begin stream\n"
";x - c\n"
"dadd r458.xy,r264.xy,cb4[0].zw_neg(y)\n"
"dadd r463.xy,r274.xy,cb4[1].zw_neg(y)\n"
"dadd r468.xy,r281.xy,cb4[2].zw_neg(y)\n"
";a . x\n"
"dmul r473.xy,cb4[0].xy,r458.xy\n"
"dmad r478.xy,cb4[1].xy,r463.xy,r473.xy\n"
"dmad r484.xy,cb4[2].xy,r468.xy,r478.xy\n"
";xs += dotted * (-a)\n"
"dmad r491.xy,r484.xy,cb4[0].xy_neg(y),r458.xy\n"
"dmad r498.xy,r484.xy,cb4[1].xy_neg(y),r463.xy\n"
"dmad r505.xy,r484.xy,cb4[2].xy_neg(y),r468.xy\n"
";sqrv\n"
"dmul r510.xy,r491.xy,r491.xy\n"
"dmad r516.xy,r498.xy,r498.xy,r510.xy\n"
"dmad r523.xy,r505.xy,r505.xy,r516.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"dmul r531.xy,r523.xy,cb4[3].xy_neg(y)\n"
";increment stream integral\n"
"mov r537,r531.xy\n"
"call 3\n"
"dmad r680.xy,r253.zw,r536.xy,r62.xy\n"
"mov r62.xy,r680.xy\n"
";Begin stream\n"
";x - c\n"
"dadd r691.xy,r264.xy,cb4[4].zw_neg(y)\n"
"dadd r696.xy,r274.xy,cb4[5].zw_neg(y)\n"
"dadd r701.xy,r281.xy,cb4[6].zw_neg(y)\n"
";a . x\n"
"dmul r706.xy,cb4[4].xy,r691.xy\n"
"dmad r711.xy,cb4[5].xy,r696.xy,r706.xy\n"
"dmad r717.xy,cb4[6].xy,r701.xy,r711.xy\n"
";xs += dotted * (-a)\n"
"dmad r724.xy,r717.xy,cb4[4].xy_neg(y),r691.xy\n"
"dmad r731.xy,r717.xy,cb4[5].xy_neg(y),r696.xy\n"
"dmad r738.xy,r717.xy,cb4[6].xy_neg(y),r701.xy\n"
";sqrv\n"
"dmul r743.xy,r724.xy,r724.xy\n"
"dmad r749.xy,r731.xy,r731.xy,r743.xy\n"
"dmad r756.xy,r738.xy,r738.xy,r749.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"dmul r764.xy,r756.xy,cb4[7].xy_neg(y)\n"
";increment stream integral\n"
"mov r537,r764.xy\n"
"call 3\n"
"dmad r911.xy,r253.zw,r536.xy,r63.xy\n"
"mov r63.xy,r911.xy\n"
";Begin stream\n"
";x - c\n"
"dadd r922.xy,r264.xy,cb4[8].zw_neg(y)\n"
"dadd r927.xy,r274.xy,cb4[9].zw_neg(y)\n"
"dadd r932.xy,r281.xy,cb4[10].zw_neg(y)\n"
";a . x\n"
"dmul r937.xy,cb4[8].xy,r922.xy\n"
"dmad r942.xy,cb4[9].xy,r927.xy,r937.xy\n"
"dmad r948.xy,cb4[10].xy,r932.xy,r942.xy\n"
";xs += dotted * (-a)\n"
"dmad r955.xy,r948.xy,cb4[8].xy_neg(y),r922.xy\n"
"dmad r962.xy,r948.xy,cb4[9].xy_neg(y),r927.xy\n"
"dmad r969.xy,r948.xy,cb4[10].xy_neg(y),r932.xy\n"
"mov r935.xy,r969.xy\n"
";sqrv\n"
"dmul r974.xy,r955.xy,r955.xy\n"
"dmad r980.xy,r962.xy,r962.xy,r974.xy\n"
"dmad r987.xy,r935.xy,r935.xy,r980.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"dmul r995.xy,r987.xy,cb4[11].xy_neg(y)\n"
";increment stream integral\n"
"mov r537,r995.xy\n"
"call 3\n"
"dmad r1142.xy,r253.zw,r536.xy,r61.xy\n"
"mov r61.xy,r1142.xy\n"
";End streams\n"
"iadd r1148.x,r78.x,r36.x\n"
"mov r78.x,r1148.x\n"
"uge r1153.x,r78.x,r89.x\n"
"break_logicalnz r1153.x\n"
"endloop\n"
"umul r1158.x,r36.x,r35.x\n"
"iadd r1163.x,r1158.x,cb1[2].x\n"
"uav_raw_load_id(%d) r1166.xyzw,r1163.x\n"
"mov r1167.xyzw,r1166.xyzw\n"
"dmul r1173.xy,cb1[13].xy,r1167.xy\n"
"mov r1176.xy,r1173.xy\n"
";multiply V_reff_xr_rp3 with Kahan summation\n"
"dmul r1177.xy,r50.xy,r1176.xy\n"
"mov r50.xy,r1177.xy\n"
"mov r1182.xy,r50.xy\n"
"mov r1183,r145\n"
"dadd r1187.xy,r1182.xy,r1183.zw\n"
"mov r1191.xy,r1187.xy\n"
"dadd r1195.xy,r1183.xy,r1191.xy\n"
"mov r1199.xy,r1195.xy\n"
"dadd r1203.xy,r1199.xy,r1183.xy_neg(y)\n"
"dadd r1207.xy,r1191.xy,r1203.xy_neg(y)\n"
"mov r1183.__zw,r1207.00xy\n"
"mov r1183.xy__,r1199.xy00\n"
"mov r1218,r1183\n"
"mov r145,r1218\n"
"mov r1219,r145\n"
"dmul r1220.xy,r62.xy,r1176.xy\n"
"mov r62.xy,r1220.xy\n"
"mov r1225.xy,r62.xy\n"
"mov r1226,r216\n"
"dadd r1230.xy,r1225.xy,r1226.zw\n"
"mov r1234.xy,r1230.xy\n"
"dadd r1238.xy,r1226.xy,r1234.xy\n"
"mov r1242.xy,r1238.xy\n"
"dadd r1246.xy,r1242.xy,r1226.xy_neg(y)\n"
"dadd r1250.xy,r1234.xy,r1246.xy_neg(y)\n"
"mov r1226.__zw,r1250.00xy\n"
"mov r1226.xy__,r1242.xy00\n"
"mov r1261,r1226\n"
"mov r216,r1261\n"
"mov r1262,r216\n"
"dmul r1263.xy,r63.xy,r1176.xy\n"
"mov r63.xy,r1263.xy\n"
"mov r1268.xy,r63.xy\n"
"mov r1269,r215\n"
"dadd r1273.xy,r1268.xy,r1269.zw\n"
"mov r1277.xy,r1273.xy\n"
"dadd r1281.xy,r1269.xy,r1277.xy\n"
"mov r1285.xy,r1281.xy\n"
"dadd r1289.xy,r1285.xy,r1269.xy_neg(y)\n"
"dadd r1293.xy,r1277.xy,r1289.xy_neg(y)\n"
"mov r1269.__zw,r1293.00xy\n"
"mov r1269.xy__,r1285.xy00\n"
"mov r1304,r1269\n"
"mov r215,r1304\n"
"mov r1305,r215\n"
"dmul r1306.xy,r61.xy,r1176.xy\n"
"mov r61.xy,r1306.xy\n"
"mov r1311.xy,r61.xy\n"
"mov r1312,r244\n"
"dadd r1316.xy,r1311.xy,r1312.zw\n"
"mov r1320.xy,r1316.xy\n"
"dadd r1324.xy,r1312.xy,r1320.xy\n"
"mov r1328.xy,r1324.xy\n"
"dadd r1332.xy,r1328.xy,r1312.xy_neg(y)\n"
"dadd r1336.xy,r1320.xy,r1332.xy_neg(y)\n"
"mov r1312.__zw,r1336.00xy\n"
"mov r1312.xy__,r1328.xy00\n"
"mov r1347,r1312\n"
"mov r244,r1347\n"
"mov r1348,r244\n"
";Output\n"
"mov r1349.x,l2.x\n"
"umul r1351.x,r1349.x,r120.x\n"
"iadd r1356.x,r1351.x,cb1[0].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1356.x,r145\n"
"mov r1363.x,l0.x\n"
"mov r1375.x,l2.x\n"
"umul r1365.x,r1363.x,r147.x\n"
"iadd r1370.x,r120.x,r1365.x\n"
"umul r1377.x,r1375.x,r1370.x\n"
"iadd r1383.x,r1377.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1383.x,r216\n"
"mov r1394.x,l4.x\n"
"mov r1406.x,l2.x\n"
"umul r1396.x,r1394.x,r147.x\n"
"iadd r1401.x,r120.x,r1396.x\n"
"umul r1408.x,r1406.x,r1401.x\n"
"iadd r1414.x,r1408.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1414.x,r215\n"
"mov r1425.x,l5.x\n"
"mov r1437.x,l2.x\n"
"umul r1427.x,r1425.x,r147.x\n"
"iadd r1432.x,r120.x,r1427.x\n"
"umul r1439.x,r1437.x,r1432.x\n"
"iadd r1445.x,r1439.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1445.x,r244\n"
"endif\n"
"endmain\n"
"func 2\n"
";div_custom\n"
"d2f r395.x,r394.xy\n"
"rcp r400.x___,r395.xxxx\n"
"f2d r404.xy,r400.x\n"
"dmad r412.xy,r394.xy_neg(y),r404.xy,l9.xy\n"
"dmad r417.xy,r404.xy,r412.xy,r404.xy\n"
"dmul r425.xy,r393.xy,r417.xy\n"
"dmad r434.xy,r394.xy_neg(y),r425.xy,r393.xy\n"
"dmad r392.xy,r434.xy,r417.xy,r425.xy\n"
"ret\n"
"endfunc\n"
"func 1\n"
";sqrt_custom\n"
"d2f r316.x,r315.xy\n"
"rsq r320.x___,r316.xxxx\n"
"f2d r327.xy,r320.x_neg(x)\n"
"dmul r330.xy,r327.xy,r327.xy\n"
"dmad r337.xy,r315.xy,r330.xy,l6.xy\n"
"dmul r342.xy,r327.xy,r337.xy\n"
"dmul r347.xy,r315.xy,r342.xy\n"
"dmul r352.xy,r342.xy,r347.xy\n"
"dmad r359.xy,r352.xy,l8.xy,l7.xy\n"
"dmul r314.xy,r347.xy,r359.xy\n"
"ret\n"
"endfunc\n"
"func 3\n"
";exp_custom\n"
"dmul r539.xy,r537.xy,l10.xy\n"
"dfrac r543.xy,r539.xy\n"
"dadd r547.xy,r539.xy,r543.xy_neg(y)\n"
"d2f r552.x, r547.xy\n"
"ftoi r553.x,r552.x\n"
"dadd r558.xy,r543.xy,l11.xy_neg(y)\n"
"dmul r562.xy,r558.xy,r558.xy\n"
"dmad r570.xy,r562.xy,l13.xy,l12.xy\n"
"dmad r575.xy,r562.xy,r570.xy,l14.xy\n"
"dmul r580.xy,r558.xy,r575.xy\n"
"dmad r588.xy,r562.xy,l16.xy,l15.xy\n"
"dmad r593.xy,r562.xy,r588.xy,l17.xy\n"
"dmad r599.xy,r562.xy,r593.xy,l9.xy\n"
"dmad r605.xy,r580.xy,l18.xy,r599.xy\n"
"mov r393,r580.xy\n"
"mov r394,r605.xy\n"
"call 2\n"
"dmad r669.xy,r392.xy,l19.xy,l19.xy\n"
"dldexp r536.xy,r669.xy,r553.x\n"
"ret\n"
"endfunc\n"
"end\n";

