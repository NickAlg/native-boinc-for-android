/*
 *  Copyright (c) 2010-2011 Matthew Arsenault
 *  Copyright (c) 2010-2011 Rensselaer Polytechnic Institute
 *
 *  This file is part of Milkway@Home.
 *
 *  Milkway@Home is free software: you may copy, redistribute and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation, either version 3 of the License, or (at your
 *  option) any later version.
 *
 *  This file is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "il_kernels.h"

const char* ilKernelSrc2 =
"il_cs_2_0\n"
"dcl_num_thread_per_group 64\n"
"; 2 stream kernel\n"
"dcl_cb cb0[15]  ; Constant buffer that holds ABI data\n"
"dcl_cb cb1[15]  ; Kernel arguments\n"
"dcl_cb cb2[72]  ; I'm guessing the math constants AMD uses\n"
"dcl_cb cb3[8]   ; ap constants\n"
"dcl_cb cb4[8]   ; stream constants\n"
"dcl_cb cb5[128] ; sg_dx\n"
"dcl_raw_uav_id(%d)\n"
"dcl_literal l0, 0x0, 0x0, 0x0, 0x0\n"
"dcl_literal l10, 0x0, 0x3fe00000, 0x0, 0x0\n"
"dcl_literal l6, 0x0, 0x3fe80000, 0x0, 0x0\n"
"dcl_literal l8, 0x0, 0x3ff00000, 0x0, 0x0\n"
"dcl_literal l7, 0x0, 0xbfb00000, 0x0, 0x0\n"
"dcl_literal l17, 0x0, 0xbfe00000, 0x0, 0x0\n"
"dcl_literal l5, 0x0, 0xc0080000, 0x0, 0x0\n"
"dcl_literal l4, 0x1, 0x0, 0x0, 0x0\n"
"dcl_literal l3, 0x8, 0x0, 0x0, 0x0\n"
"dcl_literal l2, 0x10, 0x0, 0x0, 0x0\n"
"dcl_literal l16, 0x389cefdd, 0x3fabf3e7, 0x0, 0x0\n"
"dcl_literal l14, 0x47900215, 0x3f33185f, 0x0, 0x0\n"
"dcl_literal l12, 0x4d1d3b2f, 0x3ef52b5c, 0x0, 0x0\n"
"dcl_literal l9, 0x652b82fe, 0x3ff71547, 0x0, 0x0\n"
"dcl_literal l18, 0x667f3bcd, 0x3ff6a09e, 0x0, 0x0\n"
"dcl_literal l11, 0xb649a8f5, 0x3f84aa4e, 0x0, 0x0\n"
"dcl_literal l15, 0xd100e689, 0x3e8657cd, 0x0, 0x0\n"
"dcl_literal l13, 0xfefa39ec, 0x3fe62e42, 0x0, 0x0\n"
"dcl_literal l1, 0xffffffff, 0xffffffff, 0xffffffff, 0xffffffff\n"
"dcl_arena_uav_id(8)\n"
"mov r17.x,cb3[1].x\n"
"mov r18.x,cb3[1].y\n"
"iadd r21.x,vAbsTid.x,cb0[6].x\n"
"mov r22.x,r21.x\n"
"inegate r23.x,cb1[9].x\n"
"iadd r24.x,r22.x,r23.x\n"
"mov r27.x,r24.x\n"
"umod r28.x,r27.x,cb1[11].x\n"
"mov r31.x,r28.x\n"
"udiv r32.x,r27.x,cb1[11].x\n"
"mov r35.x,r32.x\n"
"mov r36.x,l2.x\n"
"mov r38.x,l3.x\n"
"ult r43.x,r35.x,cb1[10].x\n"
"ult r40.x,r31.x,cb1[11].x\n"
"iand r46.x,r43.x,r40.x\n"
"mov r49.x,r46.x\n"
"if_logicalnz r49.x\n"
"mov r50.xy,l0.xy\n"
";Zero streams\n"
"mov r52.xy,l0.xy\n"
"mov r54.xy,r52.xy\n"
"mov r55.xy,l0.xy\n"
"mov r57.xy,r55.xy\n"
"mov r58.xy,r54.xy\n"
"umul r59.x,r36.x,r17.x\n"
"umul r64.x,r59.x,r35.x\n"
"mov r69.x,r64.x\n"
"iadd r70.x,r69.x,cb1[3].x\n"
"mov r73.x,r70.x\n"
"umul r74.x,r36.x,r17.x\n"
"iadd r79.x,r73.x,r74.x\n"
"mov r84.x,r79.x\n"
"umul r85.x,cb1[14].x,cb1[11].x\n"
"iadd r86.x,r85.x,r31.x\n"
"mov r89.x,r86.x\n"
"umul r90.x,r36.x,r89.x\n"
"iadd r95.x,r90.x,cb1[4].x\n"
"mov r98.x,r95.x\n"
"umul r99.x,r38.x,r89.x\n"
"iadd r104.x,r99.x,cb1[5].x\n"
"mov r107.x,r104.x\n"
"umul r108.x,r31.x,cb1[10].x\n"
"iadd r111.x,r108.x,r35.x\n"
"mov r115.x,r111.x\n"
";Read Trig\n"
"uav_raw_load_id(%d) r116.xyzw,r98.x\n"
"mov r117.xyzw,r116.xyzw\n"
"mov r120,r117\n"
"uav_raw_load_id(%d) r121.xy__,r107.x\n"
"mov r122.xy__,r121.xy00\n"
"mov r125.xy,r122.xy\n"
";read old values\n"
"mov r126.x,l2.x\n"
"umul r128.x,r126.x,r115.x\n"
"iadd r133.x,r128.x,cb1[0].x\n"
"uav_raw_load_id(%d) r136.xyzw,r133.x\n"
"mov r137.xyzw,r136.xyzw\n"
"mov r140,r137\n"
"umul r141.x,cb1[10].x,cb1[11].x\n"
"mov r142.x,r141.x\n"
"mov r143,l0\n"
"mov r145.x,l0.x\n"
"mov r157.x,l2.x\n"
"umul r147.x,r145.x,r142.x\n"
"iadd r152.x,r115.x,r147.x\n"
"umul r159.x,r157.x,r152.x\n"
"iadd r165.x,r159.x,cb1[1].x\n"
"uav_raw_load_id(%d) r170.xyzw,r165.x\n"
"mov r171.xyzw,r170.xyzw\n"
"mov r143,r171\n"
"mov r176,r143\n"
"mov r177,l0\n"
"mov r179.x,l4.x\n"
"mov r191.x,l2.x\n"
"umul r181.x,r179.x,r142.x\n"
"iadd r186.x,r115.x,r181.x\n"
"umul r193.x,r191.x,r186.x\n"
"iadd r199.x,r193.x,cb1[1].x\n"
"uav_raw_load_id(%d) r204.xyzw,r199.x\n"
"mov r205.xyzw,r204.xyzw\n"
"mov r177,r205\n"
"mov r210,r177\n"
"mov r211,r176\n"
"whileloop\n"
"uav_raw_load_id(%d) r212.xyzw,r73.x\n"
"mov r213.xyzw,r212.xyzw\n"
"mov r216,r213\n"
";coordinate conversion\n"
"dmad r223.xy,r216.xy,r120.xy,cb3[2].xy\n"
"mov r226.xy,r223.xy\n"
"dmul r233.xy,r216.xy,r120.zw\n"
"mov r236.xy,r233.xy\n"
"dmul r240.xy,r216.xy,r125.xy\n"
"mov r244.xy,r240.xy\n"
";x^2 + y^2 + z^2 / q^2\n"
"dmul r245.xy,r226.xy,r226.xy\n"
"mov r250.xy,r245.xy\n"
"dmad r251.xy,r236.xy,r236.xy,r250.xy\n"
"mov r258.xy,r251.xy\n"
"dmul r259.xy,r244.xy,r244.xy\n"
"mov r264.xy,r259.xy\n"
"dmad r265.xy,cb3[3].xy,r264.xy,r258.xy\n"
"mov r270.xy,r265.xy\n"
";sqrt()\n"
"mov r271.xy,r270.xy\n"
"mov r274,r271.xy\n"
"call 1\n"
"mov r272.xy,r273\n"
"mov r271.xy,r274\n"
"dadd r325.xy,r272.xy,cb3[2].zw\n"
"mov r328.xy,r325.xy\n"
";qw_r3_N / (rg *rs^3)\n"
"dmul r329.xy,r272.xy,r328.xy\n"
"dmul r334.xy,r329.xy,r328.xy\n"
"dmul r339.xy,r334.xy,r328.xy\n"
"mov r345.xy,r339.xy\n"
"mov r349.xy,r216.zw\n"
"mov r352,r349.xy\n"
"mov r353,r345.xy\n"
"call 2\n"
"mov r350.xy,r351\n"
"mov r349.xy,r352\n"
"mov r345.xy,r353\n"
"dadd r407.xy,r50.xy,r350.xy\n"
"mov r50.xy,r407.xy\n"
";stream loops\n"
";Begin stream\n"
";x - c\n"
"dadd r417.xy,r226.xy,cb4[0].zw_neg(y)\n"
"mov r420.xy,r417.xy\n"
"dadd r422.xy,r236.xy,cb4[1].zw_neg(y)\n"
"mov r425.xy,r422.xy\n"
"dadd r427.xy,r244.xy,cb4[2].zw_neg(y)\n"
"mov r430.xy,r427.xy\n"
";a . x\n"
"dmul r432.xy,cb4[0].xy,r420.xy\n"
"mov r435.xy,r432.xy\n"
"dmad r437.xy,cb4[1].xy,r425.xy,r435.xy\n"
"mov r435.xy,r437.xy\n"
"dmad r443.xy,cb4[2].xy,r430.xy,r435.xy\n"
"mov r435.xy,r443.xy\n"
";xs += dotted * (-a)\n"
"mov r449.xy,cb4[0].xy_neg(y)\n"
"dmad r450.xy,r435.xy,r449.xy,r420.xy\n"
"mov r420.xy,r450.xy\n"
"mov r456.xy,cb4[1].xy_neg(y)\n"
"dmad r457.xy,r435.xy,r456.xy,r425.xy\n"
"mov r425.xy,r457.xy\n"
"mov r463.xy,cb4[2].xy_neg(y)\n"
"dmad r464.xy,r435.xy,r463.xy,r430.xy\n"
"mov r430.xy,r464.xy\n"
";sqrv\n"
"dmul r469.xy,r420.xy,r420.xy\n"
"mov r474.xy,r469.xy\n"
"dmad r475.xy,r425.xy,r425.xy,r474.xy\n"
"mov r474.xy,r475.xy\n"
"dmad r482.xy,r430.xy,r430.xy,r474.xy\n"
"mov r474.xy,r482.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r489.xy,cb4[3].xy_neg(y)\n"
"dmul r490.xy,r474.xy,r489.xy\n"
"mov r474.xy,r490.xy\n"
";increment stream integral\n"
"mov r493.xy,r474.xy\n"
"mov r496,r493.xy\n"
"call 3\n"
"mov r494.xy,r495\n"
"mov r493.xy,r496\n"
"dmad r639.xy,r216.zw,r494.xy,r58.xy\n"
"mov r58.xy,r639.xy\n"
";Begin stream\n"
";x - c\n"
"dadd r650.xy,r226.xy,cb4[4].zw_neg(y)\n"
"mov r653.xy,r650.xy\n"
"dadd r655.xy,r236.xy,cb4[5].zw_neg(y)\n"
"mov r658.xy,r655.xy\n"
"dadd r660.xy,r244.xy,cb4[6].zw_neg(y)\n"
"mov r663.xy,r660.xy\n"
";a . x\n"
"dmul r665.xy,cb4[4].xy,r653.xy\n"
"mov r668.xy,r665.xy\n"
"dmad r670.xy,cb4[5].xy,r658.xy,r668.xy\n"
"mov r668.xy,r670.xy\n"
"dmad r676.xy,cb4[6].xy,r663.xy,r668.xy\n"
"mov r668.xy,r676.xy\n"
";xs += dotted * (-a)\n"
"mov r682.xy,cb4[4].xy_neg(y)\n"
"dmad r683.xy,r668.xy,r682.xy,r653.xy\n"
"mov r653.xy,r683.xy\n"
"mov r689.xy,cb4[5].xy_neg(y)\n"
"dmad r690.xy,r668.xy,r689.xy,r658.xy\n"
"mov r658.xy,r690.xy\n"
"mov r696.xy,cb4[6].xy_neg(y)\n"
"dmad r697.xy,r668.xy,r696.xy,r663.xy\n"
"mov r663.xy,r697.xy\n"
";sqrv\n"
"dmul r702.xy,r653.xy,r653.xy\n"
"mov r707.xy,r702.xy\n"
"dmad r708.xy,r658.xy,r658.xy,r707.xy\n"
"mov r707.xy,r708.xy\n"
"dmad r715.xy,r663.xy,r663.xy,r707.xy\n"
"mov r707.xy,r715.xy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r722.xy,cb4[7].xy_neg(y)\n"
"dmul r723.xy,r707.xy,r722.xy\n"
"mov r707.xy,r723.xy\n"
";increment stream integral\n"
"mov r726.xy,r707.xy\n"
"mov r496,r726.xy\n"
"call 3\n"
"mov r727.xy,r495\n"
"mov r726.xy,r496\n"
"dmad r870.xy,r216.zw,r727.xy,r57.xy\n"
"mov r57.xy,r870.xy\n"
";End streams\n"
"iadd r876.x,r73.x,r36.x\n"
"mov r73.x,r876.x\n"
"uge r881.x,r73.x,r84.x\n"
"break_logicalnz r881.x\n"
"endloop\n"
"umul r886.x,r36.x,r35.x\n"
"iadd r891.x,r886.x,cb1[2].x\n"
"uav_raw_load_id(%d) r894.xyzw,r891.x\n"
"mov r895.xyzw,r894.xyzw\n"
"dmul r901.xy,cb1[13].xy,r895.xy\n"
"mov r904.xy,r901.xy\n"
";multiply V_reff_xr_rp3 with Kahan summation\n"
"dmul r905.xy,r50.xy,r904.xy\n"
"mov r50.xy,r905.xy\n"
"mov r910.xy,r50.xy\n"
"mov r911,r140\n"
"dadd r915.xy,r910.xy,r911.zw\n"
"mov r919.xy,r915.xy\n"
"dadd r923.xy,r911.xy,r919.xy\n"
"mov r927.xy,r923.xy\n"
"dadd r931.xy,r927.xy,r911.xy_neg(y)\n"
"dadd r935.xy,r919.xy,r931.xy_neg(y)\n"
"mov r911.__zw,r935.00xy\n"
"mov r911.xy__,r927.xy00\n"
"mov r946,r911\n"
"mov r140,r946\n"
"mov r947,r140\n"
"dmul r948.xy,r58.xy,r904.xy\n"
"mov r58.xy,r948.xy\n"
"mov r953.xy,r58.xy\n"
"mov r954,r211\n"
"dadd r958.xy,r953.xy,r954.zw\n"
"mov r962.xy,r958.xy\n"
"dadd r966.xy,r954.xy,r962.xy\n"
"mov r970.xy,r966.xy\n"
"dadd r974.xy,r970.xy,r954.xy_neg(y)\n"
"dadd r978.xy,r962.xy,r974.xy_neg(y)\n"
"mov r954.__zw,r978.00xy\n"
"mov r954.xy__,r970.xy00\n"
"mov r989,r954\n"
"mov r211,r989\n"
"mov r990,r211\n"
"dmul r991.xy,r57.xy,r904.xy\n"
"mov r57.xy,r991.xy\n"
"mov r996.xy,r57.xy\n"
"mov r997,r210\n"
"dadd r1001.xy,r996.xy,r997.zw\n"
"mov r1005.xy,r1001.xy\n"
"dadd r1009.xy,r997.xy,r1005.xy\n"
"mov r1013.xy,r1009.xy\n"
"dadd r1017.xy,r1013.xy,r997.xy_neg(y)\n"
"dadd r1021.xy,r1005.xy,r1017.xy_neg(y)\n"
"mov r997.__zw,r1021.00xy\n"
"mov r997.xy__,r1013.xy00\n"
"mov r1032,r997\n"
"mov r210,r1032\n"
"mov r1033,r210\n"
";Output\n"
"mov r1034.x,l2.x\n"
"umul r1036.x,r1034.x,r115.x\n"
"iadd r1041.x,r1036.x,cb1[0].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1041.x,r140\n"
"mov r1048.x,l0.x\n"
"mov r1060.x,l2.x\n"
"umul r1050.x,r1048.x,r142.x\n"
"iadd r1055.x,r115.x,r1050.x\n"
"umul r1062.x,r1060.x,r1055.x\n"
"iadd r1068.x,r1062.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1068.x,r211\n"
"mov r1079.x,l4.x\n"
"mov r1091.x,l2.x\n"
"umul r1081.x,r1079.x,r142.x\n"
"iadd r1086.x,r115.x,r1081.x\n"
"umul r1093.x,r1091.x,r1086.x\n"
"iadd r1099.x,r1093.x,cb1[1].x\n"
"uav_raw_store_id(%d) mem.xyzw,r1099.x,r210\n"
"endif\n"
"endmain\n"
"func 2\n"
";div_custom\n"
"d2f r354.x,r353.xy\n"
"mov r357.x,r354.x\n"
"mov r358.x,r357.x\n"
"rcp r359.x___,r358.xxxx\n"
"mov r362.x,r359.x\n"
"f2d r363.xy,r362.x\n"
"mov r366.xy,r363.xy\n"
"mov r367.xy,r353.xy_neg(y)\n"
"dmad r371.xy,r367.xy,r366.xy,l8.xy\n"
"mov r375.xy,r371.xy\n"
"dmad r376.xy,r366.xy,r375.xy,r366.xy\n"
"mov r383.xy,r376.xy\n"
"dmul r384.xy,r352.xy,r383.xy\n"
"mov r389.xy,r384.xy\n"
"mov r390.xy,r353.xy_neg(y)\n"
"dmad r393.xy,r390.xy,r389.xy,r352.xy\n"
"mov r399.xy,r393.xy\n"
"dmad r400.xy,r399.xy,r383.xy,r389.xy\n"
"mov r351.xy,r400.xy\n"
"ret\n"
"endfunc\n"
"func 1\n"
";sqrt_custom\n"
"d2f r275.x,r274.xy\n"
"mov r278.x,r275.x\n"
"rsq r279.x___,r278.xxxx\n"
"mov r282.x,r279.x\n"
"mov r283.x,r282.x_neg(x)\n"
"f2d r286.xy,r283.x\n"
"mov r288.xy,r286.xy\n"
"dmul r289.xy,r288.xy,r288.xy\n"
"mov r294.xy,r289.xy\n"
"dmad r296.xy,r274.xy,r294.xy,l5.xy\n"
"mov r294.xy,r296.xy\n"
"dmul r301.xy,r288.xy,r294.xy\n"
"mov r288.xy,r301.xy\n"
"dmul r306.xy,r274.xy,r288.xy\n"
"mov r294.xy,r306.xy\n"
"dmul r311.xy,r288.xy,r294.xy\n"
"mov r288.xy,r311.xy\n"
"dmad r318.xy,r288.xy,l7.xy,l6.xy\n"
"dmul r321.xy,r294.xy,r318.xy\n"
"mov r273.xy,r321.xy\n"
"ret\n"
"endfunc\n"
"func 3\n"
";exp_custom\n"
"dmul r498.xy,r496.xy,l9.xy\n"
"mov r501.xy,r498.xy\n"
"dfrac r502.xy,r501.xy\n"
"mov r505.xy,r502.xy\n"
"dadd r506.xy,r501.xy,r505.xy_neg(y)\n"
"d2f r511.x, r506.xy\n"
"ftoi r512.x,r511.x\n"
"mov r515.x,r512.x\n"
"dadd r517.xy,r505.xy,l10.xy_neg(y)\n"
"mov r520.xy,r517.xy\n"
"dmul r521.xy,r520.xy,r520.xy\n"
"mov r526.xy,r521.xy\n"
"dmad r529.xy,r526.xy,l12.xy,l11.xy\n"
"mov r532.xy,r529.xy\n"
"dmad r534.xy,r526.xy,r532.xy,l13.xy\n"
"dmul r539.xy,r520.xy,r534.xy\n"
"mov r544.xy,r539.xy\n"
"dmad r547.xy,r526.xy,l15.xy,l14.xy\n"
"mov r550.xy,r547.xy\n"
"dmad r552.xy,r526.xy,r550.xy,l16.xy\n"
"mov r550.xy,r552.xy\n"
"dmad r558.xy,r526.xy,r550.xy,l8.xy\n"
"mov r550.xy,r558.xy\n"
"dmad r564.xy,r544.xy,l17.xy,r550.xy\n"
"mov r569.xy,r564.xy\n"
"mov r570.xy,r569.xy\n"
"mov r571.xy,r544.xy\n"
"mov r352,r571.xy\n"
"mov r353,r570.xy\n"
"call 2\n"
"mov r572.xy,r351\n"
"mov r571.xy,r352\n"
"mov r570.xy,r353\n"
"dmad r628.xy,r572.xy,l18.xy,l18.xy\n"
"mov r572.xy,r628.xy\n"
"dldexp r631.xy,r572.xy,r515.x\n"
"mov r495.xy,r631.xy\n"
"ret\n"
"endfunc\n"
"end\n";

